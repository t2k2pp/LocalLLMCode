# LocalLLM Code クラス図とシーケンス図

## 1. 全体クラス図

### 1.1 コアシステムクラス図

```mermaid
classDiagram
    class LocalLLMCode {
        -config: Config
        -react_agent: ReActAgent
        -tool_system: ToolSystem
        -project_analyzer: ProjectAnalyzer
        -llm_client: LLMClient
        -context_manager: SmartContextManager
        -external_memory: ExternalMemorySystem
        -console: Console
        -is_running: bool
        +initialize() bool
        +run_interactive() None
        +run_oneshot(prompt: str) None
        +handle_session_command(command: str) bool
        +cleanup() None
    }

    class ReActAgent {
        -llm_client: LLMClient
        -tool_system: ToolSystem
        -context_manager: SmartContextManager
        -external_memory: ExternalMemorySystem
        -multi_agent_system: MultiAgentSystem
        -max_iterations: int
        -current_iteration: int
        -thought_history: List[Dict]
        -loop_detection_threshold: int
        -stuck_patterns: List[str]
        +execute_query(query: str, context: Dict) str
        +think(current_situation: str) Dict
        +act(thought: Dict) Dict
        +observe(action_result: Dict) str
        +detect_loop() bool
        +handle_stuck_situation() str
        +auto_load_file_references(query: str) str
    }

    class MultiAgentSystem {
        -llm_clients: Dict[str, LLMClient]
        -agent_roles: Dict[str, str]
        -consultation_history: List[Dict]
        -rate_limiter: RateLimiter
        -health_checker: HealthChecker
        -fallback_providers: List[str]
        +three_wise_consultation(problem: str, context: Dict) Dict
        +boss_consultation(complex_problem: str, history: List) Dict
        +health_check_providers() Dict[str, bool]
        +select_best_provider(task_type: str) str
        +apply_rate_limiting(provider: str) bool
    }

    class ToolSystem {
        -tools: Dict[str, Tool]
        -safety_checker: SafetyChecker
        -backup_manager: BackupManager
        -command_filter: CommandFilter
        -project_root: str
        +execute_tool(tool_name: str, **kwargs) Dict
        +validate_file_operation(file_path: str, operation: str) Tuple[bool, str]
        +create_backup(file_path: str) str
        +detect_code_destruction(old_content: str, new_content: str) Dict
        +safe_command_execution(command: str) Dict
        +filter_dangerous_commands(command: str) Tuple[bool, str]
    }

    class LLMClient {
        -provider: str
        -base_url: str
        -api_key: str
        -model: str
        -max_tokens: int
        -temperature: float
        -session: ClientSession
        +chat_completion(messages: List[Dict], stream: bool) Union[str, AsyncGenerator]
        +health_check() Dict
        +auto_reconnect() bool
        +estimate_tokens(text: str) int
    }

    class SmartContextManager {
        -max_tokens: int
        -compression_threshold: float
        -relevance_scorer: RelevanceScorer
        -token_estimator: TokenEstimator
        +optimize_context(context: str, max_tokens: int) str
        +calculate_relevance_score(file_path: str, query: str) float
        +compress_content(content: str, target_ratio: float) str
        +monitor_token_usage() Dict
    }

    class ExternalMemorySystem {
        -memory_file: str
        -todo_list: List[Dict]
        -session_records: List[Dict]
        -context_cache: Dict
        -chunking_strategy: ChunkingStrategy
        +add_todo(task: str, priority: str) str
        +chunk_large_task(task: str, max_size: int) List[str]
        +search_memory(query: str, limit: int) List[Dict]
        +update_session_record(record: Dict) None
    }

    class ProjectAnalyzer {
        -project_root: str
        -language_detector: LanguageDetector
        -framework_detector: FrameworkDetector
        -style_analyzer: StyleAnalyzer
        +analyze_project() Dict
        +generate_project_dna() str
        +detect_languages() List[str]
        +detect_frameworks() List[str]
        +analyze_coding_style() Dict
    }

    LocalLLMCode "1" --> "1" ReActAgent : uses
    LocalLLMCode "1" --> "1" ToolSystem : uses
    LocalLLMCode "1" --> "1" LLMClient : uses
    LocalLLMCode "1" --> "1" SmartContextManager : uses
    LocalLLMCode "1" --> "1" ExternalMemorySystem : uses
    LocalLLMCode "1" --> "1" ProjectAnalyzer : uses
    
    ReActAgent "1" --> "1" MultiAgentSystem : consults
    ReActAgent "1" --> "1" ToolSystem : uses
    ReActAgent "1" --> "1" LLMClient : communicates
    ReActAgent "1" --> "1" SmartContextManager : uses
    ReActAgent "1" --> "1" ExternalMemorySystem : updates
    
    MultiAgentSystem "1" --> "*" LLMClient : manages
    ToolSystem "1" --> "1" ProjectAnalyzer : uses
```

## 2. パッケージ構造図

```mermaid
classDiagram
    namespace localllm {
        class main {
            +LocalLLMCode
        }
        
        namespace core {
            class project_dna {
                +ProjectAnalyzer
            }
            class context_manager {
                +SmartContextManager
            }
            class config {
                +Config
            }
            class i18n {
                +I18nManager
            }
        }
        
        namespace agents {
            class react_agent {
                +ReActAgent
            }
            class multi_agent {
                +MultiAgentSystem
            }
        }
        
        namespace llm {
            class clients {
                +LLMClient
                +LMStudioClient
                +AzureClient
                +GeminiClient
            }
        }
        
        namespace tools {
            class tool_system {
                +ToolSystem
                +FileOperations
                +CommandExecutor
            }
        }
        
        namespace memory {
            class external_memory {
                +ExternalMemorySystem
            }
            class task_chunking {
                +TaskChunker
            }
        }
    }
```

## 3. ReActエージェントシーケンス図

### 3.1 基本的なReActループ

```mermaid
sequenceDiagram
    participant User
    participant App as LocalLLMCode
    participant Agent as ReActAgent
    participant Context as ContextManager
    participant Tools as ToolSystem
    participant LLM as LLMClient
    participant Memory as ExternalMemory
    
    User->>App: ユーザークエリ入力
    App->>Agent: execute_query(query)
    
    Agent->>Context: ファイル参照解析
    Context->>Agent: 拡張クエリ
    
    Agent->>Memory: セッション開始記録
    
    loop ReAct Loop (最大反復回数まで)
        Note over Agent: Think Phase
        Agent->>Agent: think(current_situation)
        Agent->>LLM: 思考プロンプト送信
        LLM->>Agent: 思考結果
        
        Note over Agent: Act Phase  
        Agent->>Agent: act(thought)
        Agent->>Tools: execute_tool(tool_name, args)
        Tools->>Tools: 安全性チェック
        Tools->>Tools: ツール実行
        Tools->>Agent: 実行結果
        
        Note over Agent: Observe Phase
        Agent->>Agent: observe(action_result)
        Agent->>Agent: ループ検出チェック
        
        alt ループ検出された場合
            Agent->>Agent: handle_stuck_situation()
            Agent->>MultiAgent: 協議要請
            MultiAgent->>Agent: 解決提案
        end
        
        Agent->>Context: コンテキスト更新
        Agent->>Memory: 思考履歴更新
    end
    
    Agent->>Memory: 最終結果記録
    Agent->>App: 実行結果返却
    App->>User: 結果表示
```

### 3.2 マルチエージェント協議シーケンス

```mermaid
sequenceDiagram
    participant Agent as ReActAgent
    participant MAS as MultiAgentSystem
    participant Conservative as ConservativeAgent
    participant Progressive as ProgressiveAgent
    participant Judge as JudgeAgent
    participant Boss as BossAgent
    participant Health as HealthChecker
    
    Agent->>MAS: three_wise_consultation(problem)
    
    MAS->>Health: プロバイダーヘルスチェック
    Health->>MAS: 利用可能プロバイダー一覧
    
    par 三人文殊協議
        MAS->>Conservative: 慎重派の意見要求
        Conservative->>MAS: リスク評価結果
    and
        MAS->>Progressive: 積極派の意見要求  
        Progressive->>MAS: 最適化提案
    and
        MAS->>Judge: 判定役の意見要求
        Judge->>MAS: バランス評価
    end
    
    MAS->>MAS: 意見統合と最終判断
    
    alt 複雑な問題の場合
        MAS->>Boss: boss_consultation(complex_problem)
        Boss->>MAS: 上級判断
        MAS->>MAS: 最終決定更新
    end
    
    MAS->>Agent: 協議結果返却
```

## 4. ツールシステム実行シーケンス

### 4.1 安全なファイル操作シーケンス

```mermaid
sequenceDiagram
    participant Agent as ReActAgent
    participant Tools as ToolSystem
    participant Safety as SafetyChecker
    participant Backup as BackupManager
    participant FileSystem as FileSystem
    participant User
    
    Agent->>Tools: execute_tool("write_file", file_path, content)
    
    Tools->>Safety: validate_file_operation(file_path, "write")
    Safety->>Safety: パストラバーサルチェック
    Safety->>Safety: プロジェクトディレクトリ内確認
    Safety->>Tools: 検証結果
    
    alt 安全性違反の場合
        Tools->>Agent: SafetyViolationError
    else 安全な場合
        Tools->>Tools: 破壊的操作判定
        
        alt 破壊的操作の場合
            Tools->>User: 確認プロンプト表示
            User->>Tools: 承認/拒否
            
            alt 拒否の場合
                Tools->>Agent: OperationCancelledError
            end
        end
        
        Tools->>Backup: create_backup(file_path)
        Backup->>FileSystem: バックアップファイル作成
        Backup->>Tools: バックアップパス
        
        Tools->>FileSystem: ファイル書き込み実行
        FileSystem->>Tools: 実行結果
        
        Tools->>Tools: コード破壊検出
        Tools->>Tools: 操作ログ記録
        
        Tools->>Agent: 成功結果返却
    end
```

### 4.2 コマンド実行シーケンス

```mermaid
sequenceDiagram
    participant Agent as ReActAgent
    participant Tools as ToolSystem
    participant Filter as CommandFilter
    participant Executor as CommandExecutor
    participant User
    participant System as OS
    
    Agent->>Tools: execute_tool("run_command", command)
    
    Tools->>Filter: filter_dangerous_commands(command)
    Filter->>Filter: 危険パターンチェック
    Filter->>Tools: 安全性判定
    
    alt 危険コマンドの場合
        Tools->>Agent: DangerousCommandError
    else 安全な場合
        Tools->>User: コマンド実行確認
        User->>Tools: 承認/拒否
        
        alt 拒否の場合
            Tools->>Agent: OperationCancelledError
        else 承認の場合
            Tools->>Executor: safe_command_execution(command)
            Executor->>System: コマンド実行
            System->>Executor: 実行結果
            
            Executor->>Executor: 実行時間記録
            Executor->>Executor: エラーハンドリング
            
            Executor->>Tools: 実行結果
            Tools->>Tools: 実行ログ記録
            Tools->>Agent: 成功結果返却
        end
    end
```

## 5. LLM通信シーケンス

### 5.1 マルチプロバイダーLLM通信

```mermaid
sequenceDiagram
    participant Agent as ReActAgent
    participant Client as LLMClient
    participant LMStudio as LM Studio
    participant Azure as Azure ChatGPT
    participant Health as HealthChecker
    
    Agent->>Client: chat_completion(messages, stream=True)
    
    Client->>Health: 各プロバイダーヘルスチェック
    Health->>LMStudio: 接続確認
    LMStudio->>Health: 状態応答
    Health->>Azure: 接続確認  
    Azure->>Health: 状態応答
    Health->>Client: 利用可能プロバイダー
    
    Client->>Client: 最適プロバイダー選択
    
    alt LM Studio が利用可能
        Client->>LMStudio: ストリーミングリクエスト
        loop ストリーミング応答
            LMStudio->>Client: 部分応答
            Client->>Agent: 部分応答転送
        end
        LMStudio->>Client: 完了通知
    else LM Studio 不可、Azure利用
        Client->>Azure: ストリーミングリクエスト
        loop ストリーミング応答
            Azure->>Client: 部分応答
            Client->>Agent: 部分応答転送
        end
        Azure->>Client: 完了通知
    else 全プロバイダー不可
        Client->>Agent: ConnectionError
    end
    
    Client->>Agent: 完全な応答
```

## 6. メモリシステムシーケンス

### 6.1 外部メモリ操作シーケンス

```mermaid
sequenceDiagram
    participant Agent as ReActAgent
    participant Memory as ExternalMemorySystem
    participant Chunker as TaskChunker
    participant FileSystem as FileSystem
    participant Search as SearchEngine
    
    Agent->>Memory: add_todo(large_task, "high")
    
    Memory->>Chunker: chunk_large_task(large_task, max_size=2000)
    Chunker->>Chunker: タスクサイズ分析
    Chunker->>Chunker: 適切な分割点検出
    Chunker->>Memory: 分割されたタスク群
    
    loop 各分割タスク
        Memory->>Memory: タスクID生成
        Memory->>FileSystem: TODOファイル更新
    end
    
    Memory->>Agent: タスクID群返却
    
    Note over Agent: タスク検索例
    Agent->>Memory: search_memory("認証機能", limit=5)
    Memory->>Search: 関連記録検索
    Search->>Search: 関連性スコア計算
    Search->>Memory: 検索結果
    Memory->>Agent: 関連記録返却
```

## 7. エラーハンドリングシーケンス

### 7.1 包括的エラー処理

```mermaid
sequenceDiagram
    participant Agent as ReActAgent
    participant Component as AnyComponent
    participant ErrorHandler as ErrorHandler
    participant Logger as Logger
    participant User
    participant Fallback as FallbackSystem
    
    Agent->>Component: 何らかの操作実行
    Component->>Component: エラー発生
    Component->>ErrorHandler: 例外スロー
    
    ErrorHandler->>ErrorHandler: エラー分類
    ErrorHandler->>Logger: エラーログ記録
    
    alt リトライ可能エラー
        loop 最大リトライ回数まで
            ErrorHandler->>ErrorHandler: 指数バックオフ待機
            ErrorHandler->>Component: リトライ実行
            Component->>ErrorHandler: 結果
            alt 成功
                ErrorHandler->>Agent: 成功結果
            end
        end
        
        alt 最大リトライ回数到達
            ErrorHandler->>Fallback: フォールバック戦略実行
            Fallback->>ErrorHandler: 代替結果
        end
    else 致命的エラー
        ErrorHandler->>User: エラー通知
        ErrorHandler->>Agent: グレースフルデグラデーション
    end
    
    ErrorHandler->>Agent: 最終結果返却
```

## 8. 設定管理シーケンス

### 8.1 階層的設定ロード

```mermaid
sequenceDiagram
    participant App as LocalLLMCode
    participant Config as ConfigManager
    participant CLI as CLIArgs
    participant Project as ProjectConfig
    participant Global as GlobalConfig
    participant Defaults as DefaultConfig
    
    App->>Config: load_configuration()
    
    Config->>CLI: parse_command_line_args()
    CLI->>Config: CLI設定値
    
    Config->>Project: load_project_config("localllm.toml")
    alt プロジェクト設定存在
        Project->>Config: プロジェクト設定値
    else プロジェクト設定なし
        Project->>Config: 空の設定
    end
    
    Config->>Global: load_global_config("config.toml.template")
    alt グローバル設定存在
        Global->>Config: グローバル設定値
    else グローバル設定なし
        Global->>Config: 空の設定
    end
    
    Config->>Defaults: get_default_config()
    Defaults->>Config: デフォルト設定値
    
    Config->>Config: 優先順位で設定マージ
    Config->>Config: 環境固有設定適用
    Config->>Config: 設定値検証
    
    Config->>App: 最終設定オブジェクト
```

これらの図表は、LocalLLM Code システムの動作を視覚的に理解するための包括的な設計ドキュメントです。各コンポーネント間の関係性、データフロー、エラーハンドリング、設定管理などの重要な側面を詳細に示しています。